pipeline {
    agent any

    environment {
        REMOTE_USER = "ubuntu"
        REMOTE_HOST = "3.110.207.105"
        REMOTE_DIR  = "/home/ubuntu/jarvis"
        SSH_OPTS    = "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
        CRED_ID     = "jarvis-ssh-key"
        SERVICE_NAME = "jarvis.service"
    }

    stages {

        stage('Show Public IP') {
            steps {
                echo "========================================"
                echo "   ðŸš€ Deploying to Server: ${REMOTE_HOST}"
                echo "========================================"
            }
        }

        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/Pujananekar/Jarvis-Voice-Assistant.git'
            }
        }

        stage('Package & Transfer') {
            steps {
                sshagent(credentials: ["${CRED_ID}"]) {
                    sh """
                        ssh ${SSH_OPTS} ${REMOTE_USER}@${REMOTE_HOST} "mkdir -p ${REMOTE_DIR}"

                        rsync -avz -e "ssh ${SSH_OPTS}" \
                        --exclude='.git' ./ \
                        ${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_DIR}/
                    """
                }
            }
        }

        stage('Setup venv & Install Dependencies') {
            steps {
                sshagent(credentials: ["${CRED_ID}"]) {
                    sh """
ssh ${SSH_OPTS} ${REMOTE_USER}@${REMOTE_HOST} << 'EOF'
set -e
cd ${REMOTE_DIR}

sudo apt update -y
sudo apt install -y python3 python3-venv python3-pip espeak-ng espeak-ng-data

if [ ! -d "venv" ]; then
  python3 -m venv venv
fi

. venv/bin/activate
pip install --upgrade pip setuptools wheel

if [ -f requirements.txt ]; then
  pip install -r requirements.txt
fi
EOF
"""
                }
            }
        }

        stage('Create/update systemd Unit') {
            steps {
                sshagent(credentials: ["${CRED_ID}"]) {
                    sh """
ssh ${SSH_OPTS} ${REMOTE_USER}@${REMOTE_HOST} << 'EOF'
set -e

UNITFILE=/etc/systemd/system/${SERVICE_NAME}

sudo tee \$UNITFILE > /dev/null << 'UNIT'
[Unit]
Description=Jarvis Voice Assistant
After=network.target

[Service]
User=ubuntu
WorkingDirectory=${REMOTE_DIR}
Environment=PATH=${REMOTE_DIR}/venv/bin:/usr/bin:/bin
ExecStart=${REMOTE_DIR}/venv/bin/python ${REMOTE_DIR}/Jarvis/jarvis.py
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
UNIT

sudo systemctl daemon-reload
sudo systemctl enable ${SERVICE_NAME}
EOF
"""
                }
            }
        }

        stage('Restart & Verify') {
            steps {
                sshagent(credentials: ["${CRED_ID}"]) {
                    sh """
ssh ${SSH_OPTS} ${REMOTE_USER}@${REMOTE_HOST} << 'EOF'

sudo systemctl restart ${SERVICE_NAME}
sleep 2

echo "-------- SERVICE STATUS --------"
sudo systemctl status ${SERVICE_NAME} --no-pager -n 20

echo "-------- LAST 20 LOGS --------"
sudo journalctl -u ${SERVICE_NAME} -n 20 --no-pager

EOF
"""
                }
            }
        }
    }
}
