pipeline {
    agent any

    environment {
        SERVER_IP = "3.110.207.105"
        SSH_USER = "ubuntu"
    }

    stages {

        stage("Show Public IP") {
            steps {
                echo "========================================"
                echo "üöÄ Deploying to Server: ${SERVER_IP}"
                echo "========================================"
            }
        }

        stage("Checkout") {
            steps {
                git branch: 'main',
                    url: 'https://github.com/Pujananekar/Jarvis-Voice-Assistant.git'
            }
        }

        stage("Upload Files") {
            steps {
                sshagent(['ubuntu']) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ${SSH_USER}@${SERVER_IP} 'mkdir -p /home/ubuntu/jarvis'

                        rsync -avz -e ssh \
                            --exclude=.git \
                            --exclude=venv \
                            ./ ${SSH_USER}@${SERVER_IP}:/home/ubuntu/jarvis/
                    """
                }
            }
        }

        stage("Setup venv & pip install") {
            steps {
                sshagent(['ubuntu']) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ${SSH_USER}@${SERVER_IP} '
                            cd /home/ubuntu/jarvis &&
                            python3 -m venv venv &&
                            source venv/bin/activate &&
                            pip install --upgrade pip &&
                            pip install -r requirements.txt || true
                        '
                    """
                }
            }
        }

        stage("Skip Service (GUI Required)") {
            steps {
                echo "‚ùå Skipping service creation ‚Äî pyautogui cannot run on server."
                echo "‚úî Your deployment completed successfully."
            }
        }
    }
}
