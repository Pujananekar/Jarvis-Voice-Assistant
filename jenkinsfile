pipeline {
    agent any

    environment {
        REMOTE_USER = "ubuntu"
        REMOTE_HOST = "3.110.207.105"
        REMOTE_DIR  = "/home/ubuntu/jarvis"

        SSH_OPTS = "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
        CRED_ID  = "jarvis-ssh-key"

        SERVICE_NAME = "jarvis.service"
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/Pujananekar/Jarvis-Voice-Assistant.git'
            }
        }

        stage('Transfer Files') {
            steps {
                sshagent(credentials: ["${CRED_ID}"]) {
                    sh """
                        ssh ${SSH_OPTS} ${REMOTE_USER}@${REMOTE_HOST} "mkdir -p ${REMOTE_DIR}"

                        rsync -avz --delete --exclude='.git' \
                        -e "ssh ${SSH_OPTS}" ./ ${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_DIR}/
                    """
                }
            }
        }

        stage('Remote: Setup Python Environment') {
            steps {
                sshagent(credentials: ["${CRED_ID}"]) {
                    sh """
ssh ${SSH_OPTS} ${REMOTE_USER}@${REMOTE_HOST} << 'EOF'

set -e
cd ${REMOTE_DIR}

sudo apt update -y
sudo apt install -y python3 python3-pip python3-venv espeak-ng espeak-ng-data

# Create venv if missing
if [ ! -d "venv" ]; then
  python3 -m venv venv
fi

source venv/bin/activate

pip install --upgrade pip setuptools wheel

if [ -f requirements.txt ]; then
  pip install -r requirements.txt
fi

EOF
"""
                }
            }
        }

        stage('Remote: Create/Update systemd service') {
            steps {
                sshagent(credentials: ["${CRED_ID}"]) {
                    sh """
ssh ${SSH_OPTS} ${REMOTE_USER}@${REMOTE_HOST} << 'EOF'

sudo tee /etc/systemd/system/${SERVICE_NAME} > /dev/null << 'UNIT'
[Unit]
Description=Jarvis Desktop Voice Assistant
After=network.target

[Service]
User=ubuntu
Group=ubuntu
WorkingDirectory=${REMOTE_DIR}
Environment=PATH=${REMOTE_DIR}/venv/bin:/usr/bin:/bin
Environment=DISPLAY=:0
Restart=on-failure
RestartSec=3
ExecStart=${REMOTE_DIR}/venv/bin/python ${REMOTE_DIR}/Jarvis/jarvis.py
StandardOutput=append:${REMOTE_DIR}/jarvis.log
StandardError=append:${REMOTE_DIR}/jarvis.err

[Install]
WantedBy=multi-user.target
UNIT

sudo systemctl daemon-reload
EOF
"""
                }
            }
        }

        stage('Restart Service & Logs') {
            steps {
                sshagent(credentials: ["${CRED_ID}"]) {
                    sh """
ssh ${SSH_OPTS} ${REMOTE_USER}@${REMOTE_HOST} << 'EOF'

sudo systemctl restart ${SERVICE_NAME}
sleep 2
sudo systemctl status ${SERVICE_NAME} --no-pager -n 20

echo "----- Latest Logs -----"
sudo journalctl -u ${SERVICE_NAME} -n 30 --no-pager

EOF
"""
                }
            }
        }
    }
}
